<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="theme/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="theme/web.format.css">
<title>数据格式化插件</title>
</head>
<body>
<div class="container">
<div class="panel panel-primary">
<div class="panel-heading">数据格式化</div>
	<div class="panel-body">
		<div class="WEB_format_container">
			<div class="WEB_format_tree"></div>
			<div class="WEB_format_source">
				<div class="WEB_format_option">
					<div class="formatBtn indentBtn">格式化</div>
					<div class="formatBtn compressBtn">删除空格</div>
					<div class="formatBtn createTreeBtn">生成树</div>
					<div class="formatBtn emptyBtn">清空</div>
				</div>
				<div class="WEB_format_data">
					<textarea class="WEB_format_area" placeholder="请在此输入您的数据"></textarea>
				</div>
				<div class="WEB_format_message">
					
				</div>
			</div>
		</div>
	</div>
</div>
</div>
<script type="text/javascript" src="lib/jquery-1.10.2.js"></script>
<script type="text/javascript" src="ui/web.format.js"></script>
<script type="text/javascript">
$(function(){
	$(".indentBtn").click(function(){
		var sourceData=$(this).data("sourceData")||$(".WEB_format_area").val();
		var arrRule=/^\s*(\[+\n*(\n*.*)*\n*\]+|\{+\n*(\n*.*)*\n*\}+)\s*$/g;
		if(sourceData===""){
			$(".WEB_format_message").html("数据不能为空！");
			return;
		}else if(arrRule.test(sourceData)){
			$(".WEB_format_message").html("");
			try{
				var resultData=eval('('+sourceData+')');
			}catch(e){
				$(".WEB_format_message").html("数据格式化出错！");
				return;
			}
		}else{
			$(".WEB_format_message").html("数据格式不匹配！");
			return;
		}
		$(".WEB_format_message").html("");
		$(this).removeData("sourceData").data("sourceData",sourceData);
		formatData(resultData,false);
	})
	$(".compressBtn").click(function(){
		var sourceData=$(this).data("sourceData")||$(".WEB_format_area").val();
		var arrRule=/^\s*(\[+\n*(\n*.*)*\n*\]+|\{+\n*(\n*.*)*\n*\}+)\s*$/g;
		if(sourceData===""){
			$(".WEB_format_message").html("数据不能为空！");
			return;
		}else if(arrRule.test(sourceData)){
			$(".WEB_format_message").html("");
			try{
				var resultData=eval('('+sourceData+')');
			}catch(e){
				$(".WEB_format_message").html("数据格式化出错！");
				return;
			}
		}else{
			$(".WEB_format_message").html("数据格式不匹配！");
			return;
		}
		$(".WEB_format_message").html("");
		$(this).removeData("sourceData").data("sourceData",sourceData);
		formatData(resultData,true);
	})

	$(".emptyBtn").click(function(){
		$(".indentBtn").removeData("sourceData");
		$(".WEB_format_area").val("");
	})

	function formatData(data,compress){
		var draw=[],//保存解析后的数据
			line='\n',//换行符
			ind="    ",//缩进符
			nodeCount=0,//最大节点数量
			maxDepth=0;//最大深度
			if(compress){
				line=ind="";
			}
		var readData=function(name,value,isLast,indent,formObj){

			nodeCount++;//递增节点

			for (var i=0,tab='';i<indent;i++ ){//递增缩进
				tab+=ind
			}

			maxDepth=++indent;//递增级别
			if($.type(value)==='array'){//处理数组
					draw.push(tab+(formObj?('"'+name+'":'):'')+'['+line);/*缩进'[' 然后换行*/

					for (var i=0;i<value.length;i++){
						readData(i,value[i],i==value.length-1,indent,false);
					}

					draw.push(tab+']'+(isLast?line:(','+line)));/*缩进']'换行,若非尾元素则添加逗号*/

			}else if($.type(value)==='object'){//处理对象
					draw.push(tab+(formObj?('"'+name+'":'):'')+'{'+line);//缩进'{' 然后换行
					var len=0,i=0;
					for(var key in value){
						len++
					};
					for(var key in value){
						readData(key,value[key],++i==len,indent,true)
					};
					draw.push(tab+'}'+(isLast?line:(','+line)));//缩进'}'换行,若非尾元素则添加逗号
			}else{
					if(typeof value=='string'){
						value='"'+value+'"'
					};
					draw.push(tab+(formObj?('"'+name+'":'):'')+value+(isLast?'':',')+line);
			}
		}

		readData('',data,true,0,false);
		$(".WEB_format_message").html('共处理节点<b>'+nodeCount+'</b>个,最大树深为<b>'+maxDepth+'</b>');
		$(".WEB_format_area").val(draw.join(''));
	}
})
</script>
</body>
</html>
