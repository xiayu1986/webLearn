!function($,window,document,undefined){var defaults={isInitTree:!0,textConf:{format:"格式化",compress:"压缩",treeView:"生成树",empty:"清空",root:"根节点",placeholder:"请在此输入您的数据"},indentClass:4,lineBreak:"\n",expandAll:!1,menu:[{text:"展开所有",method:function(e){methods.openAllNode(e)}},{text:"收起所有",method:function(e){methods.closeAllNode(e)}},{text:"新增",method:function(e){methods.appendNode(e)}},{text:"删除",method:function(e){methods.deleteNode(e)}},{text:"复制",method:function(){}},{text:"编辑",method:function(){}}],offsetY:10},methods={init:function(e){return this.each(function(){var t=$(this).data("WEB_format_settings");t?this.settings=$.extend(!0,{},t,e):(this.settings=$.extend(!0,{},defaults,e),$(this).data("WEB_format_settings",this.settings)),methods._createFormatContainer.call(this)})},_createFormatContainer:function(){var e=$(this).find(".WEB_format_container");if(!(e.length>0)){var t='<div class="WEB_format_container"><div class="WEB_format_tree"></div><div class="WEB_format_source"><div class="WEB_format_option"><div class="actionBtn format">'+this.settings.textConf.format+'</div><div class="actionBtn compress">'+this.settings.textConf.compress+'</div><div class="actionBtn treeView">'+this.settings.textConf.treeView+'</div><div class="actionBtn empty">'+this.settings.textConf.empty+'</div></div><div class="WEB_format_data"><textarea class="WEB_format_area" placeholder="'+this.settings.textConf.placeholder+'"></textarea></div><div class="WEB_format_message"></div></div></div>';$(this).html(t),methods._createFormatEvents.call(this)}},_createFormatEvents:function(){var e=$(this).find(".WEB_format_area"),t=$(this).find(".WEB_format_tree"),n=$(this).find(".WEB_format_message"),o=this;$(this).off(".format").on("click.format",".actionBtn",function(){if($(this).hasClass("empty"))e.val(""),t.html(""),n.html("");else{var s=e.val(),a=!!$(this).hasClass("compress"),i=methods._checkOutJson.call(o,s);if("object"!==$.type(i))return;$(this).hasClass("treeView")?methods._createTreeView.call(o,i.data):methods._formatData.call(o,i.data,a)}}),e.on("input keyup",function(){var t=e.val(),n=methods._checkOutJson.call(o,t);"object"===$.type(n)&&methods._createTreeView.call(o,n.data)}),t.on("click",".node-name",function(){var e=$(this).siblings("ul"),t=e.hasClass("node-tree-close");0!==e.length&&(t?methods.openNode.call(o,$(this)):methods.closeNode.call(o,$(this)))}).on("contextmenu",".node-name",function(e){}),$(document).click(function(){})},_formatData:function(e,t){for(var n="",o=0;o<this.settings.indentClass;o++)n+=" ";var s=[],a=this.settings.lineBreak,i=0,r=0,c=[],l=$(this).find(".WEB_format_message"),d=$(this).find(".WEB_format_area");t&&(a=n="");var f=function(e,t,o,l,d){i++;for(var h=0,m="";h<l;h++)m+=n;if(r=++l,c.push(r),"array"===$.type(t)){s.push(m+(d?'"'+e+'":':"")+"["+a);for(var u=0;u<t.length;u++)f(u,t[u],u==t.length-1,l,!1);s.push(m+"]"+(o?a:","+a))}else if("object"===$.type(t)){s.push(m+(d?'"'+e+'":':"")+"{"+a);var p=0,v=0;for(var _ in t)p++;for(var g in t)f(g,t[g],++v==p,l,!0);s.push(m+"}"+(o?a:","+a))}else"string"==$.type(t)&&(t='"'+t+'"'),s.push(m+(d?'"'+e+'":':"")+t+(o?"":",")+a)};f("",e,!0,0,!1),r=Math.max.apply(null,c),l.html("共处理节点<b>"+i+"</b>个,最大节点深度为<b>"+r+"</b>"),d.val(s.join(""))},_checkOutJson:function(sourceData){var message=$(this).find(".WEB_format_message"),jsonRule=/^\s*\[|\{(\n*.*)*\s*$/g;if(""===sourceData)return message.html("数据不能为空！"),!1;if(!jsonRule.test(sourceData))return message.html("数据格式不匹配！"),!1;message.html("");try{sourceData=eval("("+sourceData+")")}catch(e){return message.html("数据格式化出错！"),!1}return message.html(""),$(this).removeData("source").data("source",sourceData),{result:!0,data:sourceData}},_createTreeView:function(e){var t=[],n=this,o=0,s=0,a=0,i=[],r=function(e,s,c,l,d,f){var h=0,m=n.settings.expandAll?"tree-icon tree-icon-close":"tree-icon tree-icon-open";"array"===$.type(l)?h=l.length:"object"===$.type(l)&&$.each(l,function(){h++}),o++,a=++f,i.push(a),""===e&&t.push('<ul class="node-tree">'),t.push('<li class="node-tree-item">');var u=f+"-"+o;if("array"===$.type(l)||"object"===$.type(l)){t.push('<div class="node-name" coordinate="'+u+'">',methods._createTreeIcon.call(n,e,m,"tree-icon tree-icon-"+$.type(l),c,""),"</div>");var p=n.settings.expandAll?"node-tree":"node-tree-close";t.push('<ul class="'+p+'">');var v=0,_=!1,g=!1;$.each(l,function(t,o){"array"===$.type(l)?_=t===h-1:"object"===$.type(l)&&(v++,g=!0,_=v===h),r(e+methods._createPrefixIcon.call(n,""===e?"tree-icon":s?"tree-icon":"tree-icon tree-icon-line"),_,t,o,g,f)}),t.push("</ul>")}else t.push('<div class="node-leaf" coordinate="'+u+'">',methods._createTreeIcon.call(n,e,s?"tree-icon tree-icon-end":"tree-icon tree-icon-join",d?"tree-icon tree-icon-default":"tree-icon tree-icon-number",c,l),"</div>");t.push("</li>"),""===e&&t.push("</ul>")};return $.isEmptyObject(e)?void $(this).find(".WEB_format_message").html("无法绘制空对象！"):(r("",!0,this.settings.textConf.root,e,!1,0),$(this).find(".WEB_format_tree").html(t.join("")),s=Math.max.apply(null,i),void $(this).find(".WEB_format_message").html("共处理节点<b>"+o+"</b>个,最大节点深度为<b>"+s+"</b>"))},_createTreeIcon:function(e,t,n,o,s){return s&&"string"===$.type(s)&&(s='"'+s+'"'),e+methods._createPrefixIcon(t)+methods._createPrefixIcon(n)+'<span class="leaf-item">'+o+(""===s?"":":")+s+"</span>"},_createPrefixIcon:function(e){return'<span class="'+e+'"></span>'},openAllNode:function(e){var t=$(e).find(".node-tree-close");0!==t.length&&t.each(function(){var t=$(this).siblings(".node-name");methods.openNode.call(e,t)})},closeAllNode:function(e){var t=$(e).find("ul.node-tree");0!==t.length&&t.each(function(){var t=$(this).siblings(".node-name");methods.closeNode.call(e,t)})},openNode:function(e){var t=e.siblings("ul"),n=e.find(".tree-icon"),o=n.eq(n.length-2);t.removeClass("node-tree-close").addClass("node-tree"),o.removeClass("tree-icon-open").addClass("tree-icon-close")},closeNode:function(e){var t=e.siblings("ul"),n=e.find(".tree-icon"),o=n.eq(n.length-2);t.removeClass("node-tree").addClass("node-tree-close"),o.removeClass("tree-icon-close").addClass("tree-icon-open"),e.removeClass("WEB_format_selected")},appendNode:function(e){var t=$(e).find(".WEB_format_selected"),n=t.attr("coordinate"),o=n.split("-"),s=$(e).data("source"),a=0,i=t.parent(),r=(t.siblings(".node-tree"),function(e,t){if(a++,++t,t!=o[0]||a!=o[1])"array"!==$.type(e)&&"object"!==$.type(e)||$.each(e,function(e,n){r(n,t)});else{i.find(".node-tree > .node-tree-item").last().clone(!0)}});r(s,0)},deleteNode:function(e){var t=$(e).find(".WEB_format_selected"),n=t.attr("coordinate"),o=n.split("-"),s=$(e).data("source"),a=0,i=(t.parent(),t.siblings(".node-tree"),function(e,t){return a++,++t,t==o[0]&&a==o[1]?(delete e,void $(this).find(".WEB_format_area").val(JSON.stringify(e))):void("array"!==$.type(e)&&"object"!==$.type(e)||$.each(e,function(e,n){i(n,t)}))});i(s,0)},_createContextMenu:function(e){e.preventDefault();var t=$(e.currentTarget),n=this;if($(".WEB_format_selected").removeClass("WEB_format_selected"),t.addClass("WEB_format_selected"),"array"===$.type(this.settings.menu)&&!$.isEmptyObject(this.settings.menu)){var o=$("#WEB_format_contextMenu");o.remove(),o=$('<ul id="WEB_format_contextMenu" class="WEB_format_contextMenu"></ul>');var s=this.settings.menu;$.each(s,function(e,t){var s=$('<li class="WEB_format_contextMenu_item">'+(t.text||"请配置节点名称")+"</li>");s.off("click").on("click",function(e){t.method(n)}),o.append(s)}),o.appendTo($("body")).css({left:e.clientX,top:e.clientY+this.settings.offsetY})}}};$.fn.WEB_format=function(){var e="Microsoft Internet Explorer"==navigator.appName&&navigator.appVersion.split(";")[1].replace(/[ ]/g,"");if("MSIE8.0"==e||"MSIE7.0"==e||"MSIE6.0"==e||"MSIE5.0"==e)return void alert("您的浏览器版本过低，本插件无法提供支持，请升级！");var t,n=arguments[0];if(methods[n]&&"_"!=n.charAt(0))n=methods[n],t=Array.prototype.slice.call(arguments,1);else{if("object"!=typeof n&&n)return $.error("方法未正确调用"),this;n=methods.init,t=arguments}return n.apply(this,t)}}(jQuery,window,document);